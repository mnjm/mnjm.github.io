---
import type { MarkdownHeading } from "astro";

type Props = {
  headings: MarkdownHeading[];
};

type HeadingWithSubheadings = MarkdownHeading & {
  subheadings: MarkdownHeading[];
};

const { headings } = Astro.props;

const grouppedHeadings = headings.reduce((array, heading) => {
  const cleanText = heading.text.replace(/#+\s*$/, "");
  const cleanedHeading = { ...heading, text: cleanText };
  if (heading.depth === 2) {
    array.push({ ...cleanedHeading, subheadings: [] });
  } else if (heading.depth === 3) {
    array.at(-1)?.subheadings.push(cleanedHeading);
  }
  return array;
}, [] as HeadingWithSubheadings[]);
---

<style>
  details[open] .content {
    max-height: 1000px; /* large enough to fit content */
  }

  .content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.5s ease;
  }
</style>

<div class="not-prose my-4 rounded-lg bg-neutral-800 p-2 text-sm text-neutral-100">
  <details
    id="table-of-contents"
    aria-label="Table Of Contents"
    class="border-l-2 border-neutral-500 pl-1 text-neutral-100 transition-all [&[open]]:border-red-600"
  >
    <summary class="cursor-pointer list-none appearance-none pl-2 font-extrabold select-none">
      Table of Contents
    </summary>
    <div class="content">
      <ol class="space-y-2 pl-4">
        {
          grouppedHeadings.map((h) => (
            <li class="m-0">
              <a
                href={`#${h.slug}`}
                class="block rounded px-2 py-1 transition-colors hover:bg-neutral-700 hover:text-white"
              >
                {h.text}
              </a>
              {h.subheadings.length > 0 && (
                <ol class="ml-4 space-y-1 pl-3 text-neutral-300">
                  {h.subheadings.map((sub) => (
                    <li class="m-0">
                      <a
                        href={`#${sub.slug}`}
                        class="block rounded px-2 py-1 transition-colors hover:bg-neutral-700 hover:text-white"
                      >
                        {sub.text}
                      </a>
                    </li>
                  ))}
                </ol>
              )}
            </li>
          ))
        }
      </ol>
    </div>
  </details>
</div>
